local a={}local b={}local c;local d={}local e,f=colors.white,colors.gray;local g,h=colors.black,colors.white;local i,j=colors.black,colors.lightGray;local function k(e,f)local l=c.getTextColor()local m=c.getBackgroundColor()c.setTextColor(e or l)c.setBackgroundColor(f or m)return l,m end;local function n(o,p,q,r)c.setCursorPos(o,p+r)local s,s,t=c.getLine(p+r)local u=c.getTextColor()local v=colors.toBlit(u)c.blit(("\131"):rep(q),v:rep(q),t:sub(o,o+q-1))c.setCursorPos(o+q,p+r)c.blit("\129",v,t:sub(o+q-1,o+q-1))for w=1,r do s,s,t=c.getLine(p+w-1)c.setCursorPos(o+q,p+w-1)c.blit("\149",v,t:sub(o+q,o+q))end end;function a.button(x,y,z)local A={label=x,callback=y,submenu=z}if z then z.parent=A end;function A.click()if A.callback then A.callback(A)end;d={}if A.submenu then d[A.depth]=A.entry;local B=A;for w=A.depth-1,1,-1 do B=B.parent.parent;d[w]=B.entry end end end;return A end;function a.toggleButton(x,y)local A=a.button(x,y)function A.setValue(C)A.value=C;A.label=("[%1s] %s"):format(C and"*"or" ",x)if A.parent then A.parent.updateSize()end end;A.setValue(false)function A.click()A.setValue(not A.value)if A.callback then A.callback(A)end;d[A.depth]=nil end;return A end;function a.absMenu()local D={x=1,y=2,width=1,height=1,depth=1}function D.render(E)error("Render of abstract menu called!")end;function D.updatePos(o,p)local q,r=c.getSize()o,p=o or D.x,p or D.y;p=math.min(p,r-D.height)local F=q-D.width;o=math.min(F,o)D.x=o;D.y=p end;function D.click(o,p)error("Click of abstract menu called!")end;function D.updateDepth(w)D.depth=w end;return D end;function a.charMenu(y)local D=a.absMenu()D.callback=y;D.color=colors.black;D.width,D.height=16,16;function D.render(E)local l,m=k()for p=1,D.height do local G=""for o=1,D.width do G=G..string.char((p-1)*D.width+o-1)end;c.setCursorPos(D.x,D.y+p-1)c.blit(G,colors.toBlit(D.color):rep(#G),("0"):rep(#G))end;k(f,m)n(D.x,D.y,D.width,D.height)k(l,m)end;function D.click(o,p)local w=(p-1)*D.width+o-1;local H=string.char(w)if D.callback then D.callback(D,H)end;return w end;return D end;local I={}I.byIndex={}I.byColor={}I.byChar={}for w=0,15 do local J={}J.index=w;J.color=2^w;J.char=("%x"):format(w)I.byIndex[J.index]=J;I.byColor[J.color]=J;I.byChar[J.char]=J end;function a.colorMenu(y)local D=a.absMenu()D.selected=15;D.selectedCol=colors.black;D.selectedChar="f"D.width,D.height=4,4;D.callback=y;function D.setSelected(w)local K=I.byIndex[w]or I.byChar[w]or I.byColor[w]assert(K,("Invalid color selector %s"):format(tostring(w)))D.selected=K.index;D.selectedCol=K.color;D.selectedChar=K.char end;function D.render(E)local l,m=k()for o=1,4 do for p=1,4 do c.setCursorPos(o+D.x-1,p+D.y-1)local w=o+(p-1)*4-1;c.blit("\7",("%x"):format(w),D.selected==w and D.selectedChar or"0")end end;k(D.selectedCol,m)n(D.x,D.y,D.height,D.width)k(l,m)end;function D.click(o,p)D.setSelected(o+(p-1)*4-1)if D.callback then D.callback(D)end;return D.selected end;return D end;function a.radialMenu(L,y)local D=a.absMenu()D.options=L;D.selected=1;D.callback=y;local M=1;D.height=#D.options;for s,N in ipairs(D.options)do M=math.max(M,#N+3)end;D.width=M;function D.render(E)local l,m=k()local O=(" %%1s%%-%ds"):format(D.width-2)for w,N in ipairs(D.options)do if D.selected==w then k(g,h)else k(i,j)end;c.setCursorPos(D.x,D.y+w-1)c.write(O:format(w==D.selected and"\7"or"\186",N))end;k(f,m)n(D.x,D.y,D.width,D.height)k(l,m)end;function D.click(o,p)D.selected=p;if D.callback then D.callback(D)end;return p end;return D end;function a.buttonMenu(P)local D=a.absMenu()D.buttons=P;for w,N in ipairs(D.buttons)do N.entry=w;N.parent=D end;function D.updateSize()local M=1;D.height=#D.buttons;for s,N in ipairs(D.buttons)do M=math.max(M,#N.label+3)end;D.width=M;for w,N in ipairs(D.buttons)do if N.submenu then N.submenu.updatePos(D.x+D.width,D.y+w-1)end end end;D.updateSize()function D.render(E)local l,m=k()local O=(" %%-%ds%%1s"):format(D.width-2)for w,N in ipairs(D.buttons)do if d[E]==w then k(g,h)else k(i,j)end;c.setCursorPos(D.x,D.y+w-1)c.write(O:format(N.label,N.submenu and">"or" "))end;local Q=D.buttons[d[E]]k(f,m)n(D.x,D.y,D.width,D.height)k(l,m)if Q and Q.submenu then Q.submenu.render(E+1)end end;local R=D.updatePos;function D.updatePos(o,p)R(o,p)for w,N in ipairs(D.buttons)do if N.submenu then N.submenu.updatePos(D.x+D.width,D.y+w-1)end end end;function D.click(o,p)local A=D.buttons[p]A.click()return p end;function D.updateDepth(w)for s,N in ipairs(D.buttons)do N.depth=w;if N.submenu then N.submenu.updateDepth(w+1)end end end;return D end;function a.bar(P)local S={buttons=P,buttonEnds={}}local o=1;for w,N in ipairs(S.buttons)do N.depth=1;N.entry=w;N.parent=S;if N.submenu then N.submenu.updatePos(o)N.submenu.updateDepth(2)end;o=o+#N.label+2;S.buttonEnds[w]=o end;function S.render()c.setCursorPos(1,1)local l,m=k(e,f)c.clearLine()for w,N in ipairs(S.buttons)do if d[1]==w then k(i,j)else k(e,f)end;c.write(" "..N.label.." ")end;local Q=S.buttons[d[1]]k(l,m)if Q and Q.submenu then Q.submenu.render(2)end end;function S.click(o,p)if p==1 then local J;for w,N in ipairs(S.buttonEnds)do if o<N then J=w;break end end;if J then local A=S.buttons[J]A.click()else d={}end;return true end;local D=S;local T={}for E=1,#d do local N=d[E]if not(D and D.buttons)then break end;D=D.buttons[N].submenu;T[#T+1]=D end;for E=1,#T,1 do local D=T[E]if o>=D.x and o<D.x+D.width and p>=D.y and p<D.y+D.height then local U=D.click(o-D.x+1,p-D.y+1)if U then return true end end end;if#d>0 then d={}return true end;return false end;local V={}local W={}function S.shortcut(A,X,Y,Z,_)local a0={}local x={}if _ then a0[#a0+1]=keys.leftAlt;x[#x+1]="alt+"end;if Y then a0[#a0+1]=keys.leftCtrl;x[#x+1]="^"end;if Z then a0[#a0+1]=keys.leftShift;x[#x+1]=keys.getName(X):upper()else x[#x+1]=keys.getName(X)end;a0[#a0+1]=X;a0.button=A;A.label=("%s (%s)"):format(A.label,table.concat(x))A.parent.updateSize()assert(V[X]==nil,("Attempt to register repeated shortcut (%s)"):format(table.concat(x)))V[X]=a0;return a0 end;function S.resetKeys()W={}end;function S.onEvent(a1)local a2=#d>0;if a1[1]=="mouse_click"then return S.click(a1[3],a1[4])elseif a1[1]=="key"then W[a1[2]]=true;local a0=V[a1[2]]if a0 then for s,N in ipairs(a0)do if not W[N]then return end end;a0.button.click()return true end elseif a1[1]=="key_up"then W[a1[2]]=nil elseif a2 and(a1[1]=="mouse_drag"or a1[1]=="mouse_up")then return true end end;return S end;function a.setWindow(a3)c=a3 end;local function a4(o,p,q,r)local O=(" "):rep(q)for w=0,r-1 do c.setCursorPos(o,p+w)c.write(O)end end;function a.popup(a5,a6,L,q)c.setCursorBlink(false)local a7,a8=c.getSize()local l,m=k(i,j)local a9=0;for s,N in ipairs(L)do a9=a9+#N+3 end;q=math.max(a9,q or 0)local aa=math.floor((a7-a9)/2)local ab={}local O=require("cc.strings").wrap(a6,q-2)local r=#O+5;local o,p=math.floor((a7-q)/2),math.floor((a8-r)/2)local ac=p+r-2;a4(o,p,q,r)for w,N in ipairs(O)do c.setCursorPos(o+1,p+w+1)c.write(N)end;k(e,f)a4(o,p,q,1)local ad=math.floor((a7-#a5)/2)c.setCursorPos(ad,p)c.write(a5)for w,N in ipairs(L)do k(g,h)c.setCursorPos(aa,ac)c.write(" "..N.." ")k(f,e)n(aa,ac,#N+2,1)ab[w]=aa;aa=aa+#N+3 end;k(f,m)n(o,p,q,r)k(l,m)while true do local s,s,o,p=os.pullEvent("mouse_click")if p==ac and o<aa then for w=#L,1,-1 do if o>=ab[w]then return w end end end end end;function a.popupRead(a5,q,a6,ae)c.setCursorBlink(false)local a7,a8=c.getSize()local l,m=k(i,j)local r=6;local o,p;if a6 then local O=require("cc.strings").wrap(a6,q-2)r=#O+7;o,p=math.floor((a7-q)/2),math.floor((a8-r)/2)a4(o,p,q,r)for w,N in ipairs(O)do c.setCursorPos(o+1,p+w+1)c.write(N)end else o,p=math.floor((a7-q)/2),math.floor((a8-r)/2)a4(o,p,q,r)end;k(e,f)a4(o,p,q,1)local ad=math.floor((a7-#a5)/2)c.setCursorPos(ad,p)c.write(a5)k(f,m)n(o,p,q,r)local af=p+r-4;local ag=window.create(c,o+1,af,q-2,1)ag.setTextColor(g)ag.setBackgroundColor(h)ag.clear()ag.setCursorPos(1,1)local ah=o+1;local ai=p+r-2;local aj=8;k(g,h)c.setCursorPos(ah,ai)c.write(" Cancel ")k(f,e)n(ah,ai,aj,1)local ak=term.redirect(ag)local C;parallel.waitForAny(function()C=read(nil,nil,ae)end,function()while true do local s,s,o,p=os.pullEvent("mouse_click")if o>=ah and o<ah+aj and p==ai then return end end end)term.redirect(ak)k(l,m)return C end;local al="\160"local am={c=3,r=2,a=3,p=2}function b.extractEscapeCodes(O)local an={}local ao={}local ap=1;local aq=1;while aq<=#O do local H=O:sub(aq,aq)if H==al then local ar=O:sub(aq+1,aq+1)local q=assert(am[ar],("Invalid escape code %s"):format(ar))an[ap]=an[ap]or{}local as=O:sub(aq+1,aq+q-1)table.insert(an[ap],as)aq=aq+q else ao[ap]=H;ap=ap+1;aq=aq+1 end end;return ao,an end;function b.wrapString(O,M)local G,at=b.extractEscapeCodes(O)local au=table.concat(G,"")local av=1;local aw,ax=1,1;local ao={}local function ay(H)if ax>M then ax=1;aw=aw+1 end;ao[aw]=ao[aw]or{}ao[aw][ax]=H;ax=ax+1 end;local function az(aA)end;while av<=#G do local H=G[av]if H:match("%S")then local aB=1;while G[av+aB-1]:match("%S")do aB=aB+1;if av+aB-1>#G then break end end;if M-ax<aB and aB<M then aw=aw+1;ax=1 end;for w=1,aB-1 do az(at[av+w-1])ay(G[av+w-1])end;av=av+aB-1 elseif H=="\n"then az(at[av])ay("\n")ax=1;aw=aw+1;av=av+1 else az(at[av])ay(H)av=av+1 end end;for w,N in ipairs(ao)do ao[w]=table.concat(N,"")end;return ao,at end;local aC="^shrekdoc%-v(%d%d)w(%d%d)h(%d%d)m([RS]):"local aD="shrekdoc-v00w00h00mR:"local function aE(G)local aF,q,r,aG=G:match(aC)assert(aF,"Invalid document (missing header!)")assert(aF=="01",("Unsupported document version v%s"):format(aF))q,r=tonumber(q),tonumber(r)assert(q and r,"Invalid document dimensions.")if aG=="R"then G=G:sub(#aD+1)elseif aG=="S"then local O=textutils.unserialise(G:sub(#aD+1))assert(type(O)=="string","Invalid serialized document.")G=O end;return G,q,r end;local function aH(aI)local k="f"local aJ="l"local G={}G[1]=("shrekdoc-v01w%02dh%02dmR:"):format(aI.pageWidth,aI.pageHeight)for w=1,#aI.content[1]do local e,f=aI.content[1]:sub(w,w),aI.content[2]:sub(w,w)local aK=aI.linestart[w]if e==al then G[#G+1]=al end;if f~=k then k=f;G[#G+1]=al.."c"..k end;if aI.pages[w]then for aL=1,aI.pages[w]do G[#G+1]=al.."p"end end;if aK and aK.alignment~=aJ then aJ=aK.alignment;G[#G+1]=al.."a"..aJ end;G[#G+1]=e end;return table.concat(G,"")end;local aM={}local aN={__index=aM}local function aO(aP)if type(aP)=="table"then local aQ={}for aR,N in pairs(aP)do aQ[aR]=aO(N)end;return aQ end;return aP end;function aM:remove(aS,aT)aS,aT=math.min(aS,aT),math.max(aS,aT)local aU=aT-aS+1;local aI=aO(self.editable)for w=aS,aT do aI.linestart[w]=nil;aI.pages[w]=nil end;for w=aS,#aI.content[1]do if aI.linestart[w]then aI.linestart[w-aU]=aI.linestart[w]aI.linestart[w]=nil end;if aI.pages[w]then aI.pages[w-aU]=aI.pages[w]aI.pages[w]=nil end end;aI.content[1]=aI.content[1]:sub(1,aS-1)..aI.content[1]:sub(aT+1)aI.content[2]=aI.content[2]:sub(1,aS-1)..aI.content[2]:sub(aT+1)return aH(aI)end;function aM:setAlignment(av,aJ)local aI=aO(self.editable)for w=av,1,-1 do local aV=aI.linestart[w]if aV then aV.alignment=aJ;break end end;return aH(aI)end;function aM:setColor(k,aS,aT)aS,aT=math.min(aS,aT),math.max(aS,aT)local aW=aT-aS+1;local aI=aO(self.editable)local O=aI.content[2]aI.content[2]=O:sub(1,aS-1)..k:rep(aW)..O:sub(aT+1,-1)return aH(aI)end;function aM:insertAt(av,G,k)local aU=#G;local aI=aO(self.editable)for w=#aI.content[1],av,-1 do if aI.linestart[w]then aI.linestart[w+aU]=aI.linestart[w]aI.linestart[w]=nil end;if aI.pages[w]then aI.pages[w+aU]=aI.pages[w]aI.pages[w]=nil end end;aI.content[1]=aI.content[1]:sub(1,av-1)..G..aI.content[1]:sub(av)aI.content[2]=aI.content[2]:sub(1,av-1)..k:rep(#G)..aI.content[2]:sub(av)return aH(aI)end;function aM:insertPage(av)local aI=aO(self.editable)aI.pages[av]=(aI.pages[av]or 0)+1;return aH(aI)end;function b.decode(G)local G,q,r=aE(G)local O,aX=b.wrapString(G,q)local aY={pages={{}},indicies={},indexlut={},pageWidth=q,pageHeight=r,editable={content={},linestart={},pages={},pageHeight=r,pageWidth=q}}local k="f"local aJ="l"local av=1;local aZ=1;local a_=1;local b0=1;local b1={}local b2={}local function b3()aY.pages[aZ]=aY.pages[aZ]or{}aY.pages[aZ][a_]={}aY.pages[aZ][a_][1]=table.concat(b2,"")aY.pages[aZ][a_][2]=table.concat(b1,"")aY.pages[aZ][a_].alignment=aJ;b1,b2={},{}a_=a_+1;b0=1 end;local function b4(as,p)for s,O in ipairs(as)do if O:sub(1,1)=="r"then k,aJ="f","l"elseif O:sub(1,1)=="c"then k=O:sub(2,2)elseif O:sub(1,1)=="a"then aJ=O:sub(2,2)elseif O:sub(1,1)=="p"then b3()aZ=aZ+1;a_=1;aY.editable.pages[av]=(aY.editable.pages[av]or 0)+1 else error(("Invalid escape code %s"):format(O))end end end;for w,aK in ipairs(O)do if a_-1==r then aZ=aZ+1;aY.editable.pages[av]=(aY.editable.pages[av]or 0)+1;a_=1 end;for o=1,#aK do local H=aK:sub(o,o)if aX[av]then b4(aX[av],w)end;aY.indicies[av]={line=a_,col=b0,page=aZ}aY.indexlut[aZ]=aY.indexlut[aZ]or{}aY.indexlut[aZ][a_]=aY.indexlut[aZ][a_]or{}aY.indexlut[aZ][a_][b0]=av;b1[b0]=k;b2[b0]=H;av=av+1;b0=b0+1 end;b3()end;local b5=aY.indicies[av-1]or{line=1,col=1,page=1}aY.indicies[av]={line=b5.line,col=b5.col+1,page=b5.page}local b6=1;local b7=aZ;for aZ=1,b7 do aY.indexlut[aZ]=aY.indexlut[aZ]or{}local b8=#aY.indexlut[aZ]for aK=1,aY.pageHeight do local b9=#(aY.indexlut[aZ][aK]or{})aY.indexlut[aZ][aK]=aY.indexlut[aZ][aK]or{}for b0=1,aY.pageWidth do if aY.indexlut[aZ][aK][b0]then b6=aY.indexlut[aZ][aK][b0]else aY.indexlut[aZ][aK][b0]=b6 end;if aZ==b7 and aK==b8 and b0==b9 then b6=b6+1 end end end end;aY.pages[1][1]=aY.pages[1][1]or{"","",alignment="l",lineX=1}local ba={}local bb={}local bc=true;for bd,aZ in ipairs(aY.pages)do for a_,aK in ipairs(aZ)do ba[#ba+1]=aK[1]bb[#bb+1]=aK[2]if bc then local be=aY.indexlut[bd][a_][1]aY.editable.linestart[be]={alignment=aK.alignment}bc=false end;local b0=aK[1]:find("\n")bc=not not b0 end;if#aZ<aY.pageHeight then bc=true end end;aY.editable.content[1]=table.concat(ba,"")aY.editable.content[2]=table.concat(bb,"")aY.blit=b.render(aY)return setmetatable(aY,aN)end;function b.encode(aY)return aH(aY.editable)end;local bf="8"local bg="1"function b.render(aY,aS,aT,bh,bi,bj)aT=aT or aS;if aS and aT then aS,aT=math.min(aS,aT),math.max(aS,aT)end;local bk={}local bl="0"local bm=false;local bn=false;local p=1;for bd,aZ in ipairs(aY.pages)do local bo={}p=1;for a_=1,aY.pageHeight do local aK=aZ[a_]or{"","","",alignment="l"}aK[3]=""local bp=1;for w=1,#aK[1]do local av=aY.indexlut[bd][a_][w]if aS and aT and av>=aS and av<=aT then bm=true else bm=false end;if bi and(aY.editable.pages[av]or 0)>0 then aK[3]=aK[3]..bg else aK[3]=aK[3]..(bm and bf or"0")end end;local aJ=aK.alignment;if aJ=="c"then bp=math.floor((aY.pageWidth-#aK[1])/2)+1 elseif aJ=="r"then bp=aY.pageWidth-#aK[1]+1 end;local bq=aK[2]:sub(1,1)local br=aK[2]:sub(#aK[2],#aK[2])if#aK[2]==0 then bq,br=bl,bl else bl=br end;if aZ[a_]then aZ[a_].lineX=bp end;bo[p]={}bo[p][1]=(" "):rep(bp-1)..aK[1]..(" "):rep(aY.pageWidth-bp+1-#aK[1])if bh then bo[p][1]=bo[p][1]:gsub("\n","\182")end;bo[p][2]=bq:rep(bp-1)..aK[2]..br:rep(aY.pageWidth-bp+1-#aK[2])local bs=bn and bf or"0"local bt=bm and bf or"0"bo[p][3]=bs:rep(bp-1)..aK[3]..bt:rep(aY.pageWidth-bp+1-#aK[3])p=p+1;bn=bm end;bk[bd]=bo end;return bk end;local function bu(c,e,f)local m,l=c.getBackgroundColor(),c.getTextColor()if f then c.setBackgroundColor(f)end;if e then c.setTextColor(e)end;return l,m end;function b.blitOn(aY,aZ,o,p,c,bv)local bw=#aY[1][1][1]local b8=#aY[1]c=c or term;if bv==nil then bv=true end;local q,r=c.getSize()o=o or math.ceil((q-bw)/2)p=p or math.ceil((r-b8)/2)local l,m=bu(c,colors.black,colors.white)if bv then c.setCursorPos(o-1,p-1)c.write("\159")c.write(("\143"):rep(bw))bu(c,colors.white,colors.black)c.setCursorPos(o-1,p+b8)c.write("\130")for w=1,b8 do bu(c,colors.black,colors.white)c.setCursorPos(o-1,p+w-1)c.write("\149")bu(c,colors.white,colors.lightGray)c.setCursorPos(o+bw,p+w-1)c.write("\149")end;bu(c,colors.white,colors.black)c.setCursorPos(o+bw,p-1)c.write("\144")bu(c,colors.white,colors.lightGray)c.setCursorPos(o,p+b8)c.write(("\131"):rep(bw))c.write("\129")end;for w,aK in ipairs(aY[aZ])do c.setCursorPos(o,p+w-1)c.blit(table.unpack(aK))end;bu(c,l,m)end;function b.dump(bx,aP)local O=textutils.serialise(aP)local by=assert(fs.open(bx,"w"))by.write(O)by.close()end;local aF="PREV-0"local bz=true;local bA={...}local aS,aT;local bB=1;local bC;local bD;local bE;local bF=false;local bG=false;local bH=false;local bI,bJ;local bK;local bL;local a7,a8=term.getSize()local a3=window.create(term.current(),1,1,a7,a8)a.setWindow(a3)local function bM(q,r)bI,bJ=q,r;bK=bJ+2;bL=math.floor((a7-bI)/2)end;bM(25,21)local function bN()a7,a8=term.getSize()a3.reposition(1,1,a7,a8)bM(bI,bJ)end;local function bO()bF=true end;local function bP()bF=true;bH=true;bG=true end;local function bQ(bx)if not fs.exists(bx)then a.popup("Error",("File '%s' does not exist."):format(bx),{"Ok"},15)return false end;if fs.isDir(bx)then a.popup("Error","Directories are not documents!",{"Ok"},15)return false end;local by=assert(fs.open(bx,"r"))local O=by.readAll()by.close()local bR,bS=pcall(b.decode,O)if bR then bD=O;bE=bS;bC=bx;bO()bB=1;aS,aT=nil,nil;bM(bE.pageWidth,bE.pageHeight)return true end;a.popup("Error",bS,{"Ok :)","Ok :("},20)return false end;local function bT()if bH then local bU=a.popup("Warning","You have unsaved changes. Discard these?",{"Yes","No"},20)return bU==1 end;return true end;local function bV()if not bT()then return end;bD="shrekdoc-v01w25h21mR:"bE=b.decode(bD)bO()bB=1;bC=nil end;if bA[1]then if not bQ(bA[1])then bV()end else bV()end;local bW=1;local bk=b.render(bE,aS,aT)local bX={{state=bD,cursor=bB}}local bY;local bZ=a.button("Open",function(J)if not bT()then return end;local bx=a.popupRead("Open",15,nil,function(G)local b_=require("cc.shell.completion").file(shell,G)for w=#b_,1,-1 do if not(b_[w]:match("/$")or b_[w]:match("%.sdoc$"))then table.remove(b_,w)end end;return b_ end)if bx then bQ(bx)end end)local function c0(bx)local by=assert(fs.open(bx,"w"))by.write(bD)by.close()bH=false end;local c1=a.button("Save As",function(J)local bx=a.popupRead("Save As",15)if bx then c0(bx)bC=bx end end)local c2=a.button("Save",function(J)if not bC then c1.click()else c0(bC)end end)local c3=a.button("New",bV)local c4=a.button("Quit",function()if not bT()then return end;bz=false;return true end)local c5=a.buttonMenu({c3,bZ,c2,c1,c4})local c6=a.button("File",nil,c5)local c7=a.charMenu(function(self,H)bY(H)end)local c8=a.colorMenu(function(self)c7.color=self.selectedCol;if aS and aT then bD=bE:setColor(self.selectedChar,aS,aT)bE=b.decode(bD)bP()end end)local c9={"l","c","r"}local ca=a.radialMenu({"Left","Center","Right"},function(self)local C=c9[self.selected]bD=bE:setAlignment(bB,C)bE=b.decode(bD)bP()end)local cb=a.button("Color",nil,c8)local cc=a.buttonMenu{a.button("New Page",function(J)bD=bE:insertPage(bB)bE=b.decode(bD)bP()end),a.button("Character",nil,c7)}local cd=a.button("Undo",function(J)local G=table.remove(bX,2)if G then bD=G.state;bE=b.decode(bD)bP()bB=G.cursor end end)local ce=a.buttonMenu{cb,a.button("Alignment",nil,ca),a.button("Insert",nil,cc),cd}local cf=a.button("Edit",nil,ce)local bh=false;local cg=a.toggleButton("New Lines",function(J)bh=J.value;bO()end)local bi=false;local ch=a.toggleButton("New Pages",function(J)bi=J.value;bO()end)local ci=a.buttonMenu({cg,ch})local cj=a.button("View",nil,ci)local S;local ck=a.button("About",function()a3.setVisible(true)a.popup("About",("ShrekWord v%s"):format(aF),{"Close"},20)S.resetKeys()a3.setVisible(false)end)S=a.bar({c6,cf,cj,ck})S.shortcut(c2,keys.s,true)S.shortcut(c4,keys.q,true)S.shortcut(cd,keys.z,true)S.shortcut(c3,keys.n,true)S.shortcut(bZ,keys.o,true)function bY(O)if aS and aT then aS,aT=math.min(aS,aT),math.max(aS,aT)bD=bE:remove(aS,aT)bE=b.decode(bD)aS,aT=nil,nil end;bD=bE:insertAt(bB,O,c8.selectedChar)bB=bB+#O;bE=b.decode(bD)bP()end;local function cl(av)local K=bE.indicies[av]assert(K,("%d %d %d"):format(av,#bE.indicies,#bE.editable.content[1]))local p=(K.page-1)*bK+K.line+4-bW;local cm=1;if bE.pages[K.page][K.line]then cm=bE.pages[K.page][K.line].lineX end;assert(cm,("%d, %d, %d"):format(av,K.page,K.line))local o=K.col+bL+cm-2;return o,p end;local function cn()a3.setVisible(false)if bF then bk=b.render(bE,aS,aT,bh,bi)bF=false end;a3.clear()bW=math.max(1,bW)local co=#bE.pages*bK-a8+4;if#bE.pages*bK>a8 then bW=math.min(co,bW)else bW=1 end;local cp=math.max(1,math.floor((bW-2)/bK)+1)local cq=math.min(cp+math.ceil(a8/bK),#bE.pages)for w=cp,cq do local p=(w-1)*bK+5-bW;b.blitOn(bk,w,bL,p,a3)end;S.render()a3.setCursorBlink(true)a3.setTextColor(colors.black)a3.setCursorPos(cl(bB))a3.setVisible(true)end;local function cr(o,p)local aZ=math.floor((p+bW-4)/bK)+1;if aZ<1 then return end;local aK=p+bW-4-(aZ-1)*bK;if aK<1 or aK>bJ then return end;local b0;if o<bL or o>=bL+bI then return end;local cm=1;if bE.pages[aZ][aK]then cm=bE.pages[aZ][aK].lineX end;b0=o-bL+2-cm;return bE.indexlut[aZ][aK][b0]end;local cs={l=1,c=2,r=3}local function ct()local o,p=cl(bB)if p<3 then bW=bW-(3-p)elseif p>a8-1 then bW=bW+p-a8+1 end end;local function cu(av)bB=math.max(1,math.min(#bE.editable.content[1]+1,av))local K=bE.indicies[bB]if K and bE.pages[K.page][K.line]then local aJ=bE.pages[K.page][K.line].alignment;ca.selected=cs[aJ]local cv=bE.editable.content[2]:sub(bB,bB)if cv~=""then c8.setSelected(cv)end end;ct()end;local function cw()if aS and aT then aS,aT=math.min(aS,aT),math.max(aS,aT)bD=bE:remove(aS,aT)bE=b.decode(bD)cu(aS)aS,aT=nil,nil;bP()end end;local function cx(cy,cz)if cz<1 then cy=cy-1;if cy<1 then cy=1;cz=1 else cz=#bE.pages[cy]end elseif cz>#bE.pages[cy]then cy=cy+1;if cy>#bE.pages then cy=#bE.pages;cz=#bE.pages[cy]else cz=1 end end;return cy,cz end;local function cA(cB,cC)cC=cC or 0;cB=cB or 0;local K=bE.indicies[bB]local cy=K.page+cC;local cz=K.line+cB;cy,cz=cx(cy,cz)if not bE.pages[cy][cz]then error(("%d %d"):format(cy,cz))end;if bE.pages[cy][cz][1]==""then cz=cz+cB;cy,cz=cx(cy,cz)end;bB=bE.indexlut[cy][cz][K.col]ct()end;local function cD(a1)if a1[1]=="mouse_scroll"then bW=bW+a1[2]elseif a1[1]=="mouse_click"then local av=cr(a1[3],a1[4])aS,aT=nil,nil;cu(av or bB)bO()elseif a1[1]=="mouse_drag"then local av=cr(a1[3],a1[4])aS=bB;aT=av or aT or bB;bO()elseif a1[1]=="key"then if a1[2]==keys.backspace then if not(aS or aT)then bB=bB-1;if bB<1 then bB=1 else aS=bB;aT=bB end end;cw()elseif a1[2]==keys.delete then if not(aS or aT)then aS=bB;aT=bB end;cw()elseif a1[2]==keys.left then cu(bB-1)elseif a1[2]==keys.right then cu(bB+1)elseif a1[2]==keys.enter then cw()bY("\n")elseif a1[2]==keys.up then cA(-1)elseif a1[2]==keys.down then cA(1)elseif a1[2]==keys.pageUp then cA(-bE.pageHeight)elseif a1[2]==keys.pageDown then cA(bE.pageHeight)end elseif a1[1]=="char"then cw()bY(a1[2])elseif a1[1]=="term_resize"then bN()end end;local function cE()while bz do cn()local a1={os.pullEvent()}if not S.onEvent(a1)then cD(a1)end end end;local function cF()parallel.waitForAny(cE,function()local cG=os.startTimer(2)while true do local s,cH=os.pullEvent("timer")if cH==cG then if bG then bG=false;table.insert(bX,1,{state=bD,cursor=bB})bX[5]=nil end;cG=os.startTimer(2)end end end)end;local bR,bS=xpcall(cE,debug.traceback)term.setBackgroundColor(colors.black)term.setTextColor(colors.white)term.clear()term.setCursorPos(1,1)print(("Thank you for using ShrekWord v%s"):format(aF))if not bR then term.setTextColor(colors.red)print("Exited with error:")print(bS)end
